import { v4 as uuid } from "uuid";
import { clientController } from "../controllers/client.controller";
import { Duration, messageCase, PlayerBase } from "../interfaces";
import { Bullet } from "./bullet";
import { Client } from "./client";

export class Room {
    uuid: string;
    name: string;
    playersIds: string[];
    bullets: Bullet[];
    mapMatrix: string[];
    gameMap = `######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
##############################                                                     +----+                                               ##############################
##############################                                                     |    |                                               ##############################
##############################                                                     +----+                                               ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                +----------------+                                                                        ##############################
##############################                |                |                                                                        ##############################
##############################            +---+                |                                                                        ##############################
##############################                                 +----------------+                                                       ##############################
##############################            +---+                                 |                                                       ##############################
##############################                |                                 |                                                       ##############################
##############################                |                       +---------+                                                       ##############################
##############################                |                       |                                                                 ##############################
##############################                +-----------------------+       +------+                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                +------+                                                  ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                     +----------+                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                            +---+ +--+          +--+ +--+                                                 ##############################
##############################                            |                           |                                                 ##############################
##############################                            |                   +-------+                                                 ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            +-------------------+                                                         ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################`;

    constructor(roomName: string) {
        this.mapMatrix = this.gameMap.split("\n");
        this.uuid = uuid();
        this.name = roomName;
        this.playersIds = [];
        this.bullets = [];
        setInterval(() => {
            for (const bullet of this.bullets) {
                if (this.mapMatrix[bullet.position.y][bullet.position.x] !== " ") {
                    bullet.live = false;
                } else {
                    bullet.go();
                    for (const playerId of this.playersIds) {
                        const client = clientController.getOneById(playerId);
                        if (
                            bullet.position.x === client.position.x &&
                            bullet.position.y === client.position.y
                        ) {
                            client.hp -= 1;
                            bullet.live = false;
                        }
                    }
                }
            }
            // объеденить в одно
            this.sendAllBullets();
            this.sendAll();

            this.bullets = this.bullets.filter((bullet) => bullet.live === true);
            // console.log(this.bullets.length);
        }, 50);
    }

    getAllPos() {
        const allPos: PlayerBase[] = [];
        for (const clientId of this.playersIds) {
            const client = clientController.getOneById(clientId);
            allPos.push({
                id: client.id,
                name: client.name,
                position: client.position,
                hp: client.hp,
            });
        }
        return allPos;
    }
    deletePlayerById(playerId: string): void {
        this.playersIds = this.playersIds.filter((id) => id !== playerId);
    }

    sendAll() {
        for (const clientId of this.playersIds) {
            const client = clientController.getOneById(clientId);
            client.sendSelf({ type: messageCase.playersPos, data: this.getAllPos() });
        }
    }
    sendAllBullets() {
        for (const clientId of this.playersIds) {
            const client = clientController.getOneById(clientId);
            client.sendSelf({ type: messageCase.bullets, data: this.bullets });
        }
    }
    resetClientId(fromId: string, toId: string) {
        for (let index = 0; index < this.playersIds.length; index++) {
            if (this.playersIds[index] === fromId) {
                this.playersIds[index] = toId;
            }
        }
    }
    goTo(client: Client, duration: string) {
        switch (duration) {
            case Duration.left: {
                if (this.mapMatrix[client.position.y][client.position.x - 1] === " ") {
                    client.position.x -= 1;
                    client.duration = duration;
                }
                break;
            }
            case Duration.right: {
                if (this.mapMatrix[client.position.y][client.position.x + 1] === " ") {
                    client.position.x += 1;
                    client.duration = duration;
                }
                break;
            }
            case Duration.up: {
                if (this.mapMatrix[client.position.y - 1][client.position.x] === " ") {
                    client.position.y -= 1;
                    client.duration = duration;
                }
                break;
            }
            case Duration.down: {
                if (this.mapMatrix[client.position.y + 1][client.position.x] === " ") {
                    client.position.y += 1;
                    client.duration = duration;
                }
                break;
            }
            case Duration.shoot: {
                this.bullets.push(new Bullet(client.id, client.position, client.duration));
            }
        }
    }
}
