import fs from "fs";
import { Bullet } from "../../src/entities/bullet";
import { PlayerBase } from "../../src/interfaces";

const ws = new WebSocket(
    //@ts-ignore
    `${import.meta.env.VITE_MODE == "dev" ? "ws" : "wss"}://${import.meta.env.VITE_SOCKET_HOST}:${
        //@ts-ignore
        import.meta.env.VITE_SOCKET_PORT
    }`,
);
// let mapText = fs.readFileSync("../../src/maps/map1.txt").toString();
let mapText = `######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
##############################                                                     +----+                                               ##############################
##############################                                                     |    |                                               ##############################
##############################                                                     +----+                                               ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                +----------------+                                                                        ##############################
##############################                |                |                                                                        ##############################
##############################            +---+                |                                                                        ##############################
##############################                                 +----------------+                                                       ##############################
##############################            +---+                                 |                                                       ##############################
##############################                |                                 |                                                       ##############################
##############################                |                       +---------+                                                       ##############################
##############################                |                       |                                                                 ##############################
##############################                +-----------------------+       +------+                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                |      |                                                  ##############################
##############################                                                +------+                                                  ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                     +----------+                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                                     |          |                                                         ##############################
##############################                            +---+ +--+          +--+ +--+                                                 ##############################
##############################                            |                           |                                                 ##############################
##############################                            |                   +-------+                                                 ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            |                   |                                                         ##############################
##############################                            +-------------------+                                                         ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
##############################                                                                                                          ##############################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################
######################################################################################################################################################################`;

function setPlayers(allPlayers: PlayerBase[], bullets: Bullet[]) {
    let mapMatrix = mapText.split("\n");
    const mm: string[] = [];
    const viewRadius = 30;
    for (const player of allPlayers) {
        mapMatrix[player.position.y] =
            mapMatrix[player.position.y].substring(0, player.position.x) +
            "0" +
            mapMatrix[player.position.y].substring(player.position.x + 1);
    }
    if (bullets.length !== 0) {
        for (const bullet of bullets) {
            mapMatrix[bullet.position.y] =
                mapMatrix[bullet.position.y].substring(0, bullet.position.x) +
                "*" +
                mapMatrix[bullet.position.y].substring(bullet.position.x + 1);
        }
    }

    for (const player of allPlayers) {
        if (player.id === document.cookie.split("=")[1]) {
            for (const m of mapMatrix.slice(
                player.position.y - viewRadius,
                player.position.y + viewRadius,
            )) {
                mm.push(
                    m.substring(player.position.x - viewRadius, player.position.x + viewRadius),
                );
            }
        }
    }
    return mm;
}

function drawMap(allPlayers: PlayerBase[], bullets: Bullet[]) {
    const map = document.getElementById("game-map-div") as HTMLElement;
    const mapMatrix = setPlayers(allPlayers, bullets);
    map.textContent = mapMatrix.join("\n");
}

function send(data: string) {
    if (!ws.readyState) {
        setTimeout(() => {
            send(data);
        }, 100);
    } else {
        ws.send(data);
    }
}

onload = () => {
    const id = document.cookie.split("=")[1];
    send(`setClient_${id}`);
    drawMap([], []);
};
var keyCode = "none";
addEventListener("keydown", (e) => {
    switch (e.keyCode) {
        case 37:
            keyCode = "go_left";
            break;
        case 38:
            keyCode = "go_up";
            break;
        case 39:
            keyCode = "go_right";
            break;
        case 40:
            keyCode = "go_down";
            break;
        case 32:
            keyCode = "go_shoot";
            break;
        default:
            break;
    }
});

setInterval(() => {
    if (keyCode !== "none") {
        send(keyCode);
        keyCode = "none";
    }
}, 100);
var allPlayers: PlayerBase[] = [];
var bullets: Bullet[] = [];
ws.onmessage = (res) => {
    const response = JSON.parse(res.data);
    switch (response.type) {
        case "playersPos": {
            allPlayers = response.data;
            drawMap(allPlayers, bullets);
            break;
        }
        case "bullets": {
            bullets = response.data;
            drawMap(allPlayers, bullets);
            break;
        }

        default: {
            break;
        }
    }
};
